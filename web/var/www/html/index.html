<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>WebSocket Client</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #333333;
                color: #b3b3b3;
                padding: 20px;
                display: flex;
                flex-direction: column;
            }
            #container {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            .output-pane {
                width: 75%;
                height: 300px;
                overflow-y: scroll;
                padding: 10px;
                margin-bottom: 10px;
                resize: both;
                background-color: #444444;
                color: #b3b3b3;
                border: 1px solid #444;
                text-align: left;
                position: relative; /* Ensure the resize handle is positioned within this element */
            }
            .section {
                margin-top: 20px;
            }
            input, select, button {
                padding: 5px;
                margin-bottom: 10px;
                background-color: #4d4d4d;
                color: #b3b3b3;
                border: 1px solid #444;
                display: inline-block;
            }
            select {
                width: auto;
            }
            button {
                width: auto;
            }
            .message, .log-entry {
                margin: 5px 0;
            }
            .resize-handle {
                position: absolute;
                bottom: 0;
                right: 0;
                width: 10px;
                height: 10px;
                background-color: #666;
                cursor: se-resize;
            }
            /* Ensure all text is left-aligned */
            body, input, select, button, .output-pane {
                text-align: left;
            }
            .log-entry {
                padding: 5px;
                margin: 5px 0;
                border-radius: 3px;
            }
            .log-level-debug { background-color: #f0f0f0; color: #000; }
            .log-level-info { background-color: #d9edf7; color: #31708f; }
            .log-level-warn { background-color: #fcf8e3; color: #8a6d3b; }
            .log-level-error { background-color: #f2dede; color: #a94442; }
        </style>
    </head>
    <body>
        <div id="container">
            <h1>WebSocket Client</h1>

            <!-- Messages Output Section -->
            <div class="section">
                <h2>Messages Output:</h2>
                <button id="clearMessagesButton">Clear Messages</button>
                <div id="messages" class="output-pane"></div>
            </div>

            <!-- Sent Message Test Section -->
            <div class="section">
                <h2>Sent Message Test:</h2>
                <input type="text" id="messageInput" placeholder="Type a message..." />
                <button id="sendButton">Send</button>
            </div>

            <!-- MQTT Publish Test Section -->
            <div class="section">
                <h2>MQTT Publish Test:</h2>
                <select id="topicSelect">
                    <option value="">Select a topic...</option>
                    <option value="SWITCH">SWITCH</option>
                    <option value="DIMMER">DIMMER</option>
                </select>
                <select id="indexSelect">
                    <option value="">Select an index...</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>
                <select id="payloadSelect">
                    <option value="">Select a payload...</option>
                    <option value="ON">ON</option>
                    <option value="OFF">OFF</option>
                </select>
                <button id="publishButton">Publish</button>
            </div>

            <!-- Log Output Section -->
            <div class="section">
                <h2>Log Output:</h2>
                <button id="clearLogButton">Clear Log</button>
                <div id="log-output" class="output-pane"></div>
            </div>
        </div>

        <script type="module">
            import { WebSocketManager } from './js/ws_manager.js';
            import { Logger } from './js/utils.js';

            const wsManager = new WebSocketManager('ws://10.10.0.221:8080');
            const messagesDiv = document.getElementById('messages');
            const logOutputDiv = document.getElementById('log-output');
            const logger = new Logger(logOutputDiv);

            function makeResizable(div) {

                const resizeHandle = document.createElement("div");
                resizeHandle.classList.add("resize-handle");
                div.appendChild(resizeHandle);

                let startX, startY, startWidth, startHeight;

                resizeHandle.onmousedown = function(e) {
                    e.preventDefault();
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = div.offsetWidth;
                    startHeight = div.offsetHeight;

                    // When the mouse moves, adjust the size
                    document.onmousemove = function(e) {
                        div.style.width = `${startWidth + (e.clientX - startX)}px`;
                        div.style.height = `${startHeight + (e.clientY - startY)}px`;
                    };

                    // Stop resizing
                    document.onmouseup = function() {
                        document.onmousemove = document.onmouseup = null;
                    }
                }
            }

            window.addEventListener('load', async () => {
                try {
                    await wsManager.connect();
                    wsManager.onMessage((message) => {
                        appendMessage(`Received: ${message}`);
                    });
                } catch (error) {
                    logger.error(`Failed to connect to WebSocket server: ${error.message}`);
                }

                makeResizable(messagesDiv);
                makeResizable(logOutputDiv);

                // Add event listeners for button clicks and keydown events
                document.getElementById('sendButton').addEventListener('click', sendMessage);
                document.getElementById('messageInput').addEventListener('keydown', handleKeyDown);
                document.getElementById('publishButton').addEventListener('click', publishMqttEvent);
                document.getElementById('clearMessagesButton').addEventListener('click', () => clearOutputPane(messagesDiv));
                document.getElementById('clearLogButton').addEventListener('click', () => clearOutputPane(logOutputDiv));
            });

            window.addEventListener('beforeunload', () => {
                wsManager.disconnect();
            });

            function sendMessage() {
                const message = document.getElementById('messageInput').value.trim();
                if (message) {
                    document.getElementById('sendButton').disabled = true;
                    wsManager.sendMessage(message)
                        .then(() => {
                            appendMessage(`Sent: ${message}`);
                            document.getElementById('messageInput').value = '';
                            document.getElementById('messageInput').focus();
                            document.getElementById('sendButton').disabled = false;
                        })
                        .catch(error => {
                            logger.info(`Failed to send message: ${error.message}`);
                            document.getElementById('sendButton').disabled = false;
                        });
                }
            }

            async function publishMqttEvent() {
                const topic = document.getElementById('topicSelect').value;
                const index = document.getElementById('indexSelect').value;
                const payload = document.getElementById('payloadSelect').value;

                if (!topic || !index || !payload) {
                    logger.warn("Please select a topic, an index, and enter a payload.");
                    return;
                }

                try {
                    document.getElementById('publishButton').disabled = true;
                    logger.info(`Attempting to publish MQTT event with topic:${topic}, index:${index}, payload:${payload}`);
                    await wsManager.publishMqttEvent(topic, index, payload);
                    const message = `Published MQTT event with topic:${topic}, index:${index}, payload:${payload}`;
                    logger.info(message);
                    appendMessage(`Sent MQTT: ${message}`);

                    // Optionally clear the payload selection after successful publish
                    // document.getElementById('payloadSelect').value = '';
                } catch (error) {
                    logger.error(`Failed to publish MQTT event: ${error.message}`);
                    appendMessage(`Failed to send MQTT: ${error.message}`);
                } finally {
                    document.getElementById('publishButton').disabled = false;
                }
            }

            function handleKeyDown(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                    event.preventDefault();
                }
            }

            function appendMessage(text) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.textContent = text;
                messagesDiv.appendChild(messageElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            function clearOutputPane(div) {
                while (div.firstChild) {
                    div.removeChild(div.firstChild);
                }
            }
        </script>
    </body>
</html>
